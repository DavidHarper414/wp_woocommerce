name: Send Slack alert on PR merge test failure
description: Send a Slack alert when automated tests failed on trunk after PR merge.
permissions: {}

inputs:
    slack-bot-token:
        required: true
    channel-id:
        required: true
    test-type:
        required: true
        type: choice
        options:
            - E2E
            - API
            - k6

runs:
    using: composite
    steps:
        - name: Lowercase test type
          id: lowcase-test-type
          shell: bash
          run: echo "test-type-lowcase=$(echo ${{ inputs.test-type }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

        - name: Compose Slack message
          shell: bash
          id: compose-slack-message
          env:
              PR_NUMBER: ${{ github.event.pull_request.number }}
              PR_TITLE: ${{ github.event.pull_request.title }}
              SHA: ${{ github.event.pull_request.merge_commit_sha }}
              SLACK_MESSAGE: |
                  :warning-8c: ${{ inputs.test-type }} tests failed after PR <https://github.com/woocommerce/woocommerce/pull/${{ env.PR_NUMBER }}|#${{ env.PR_NUMBER }}> was merged.

                  :pr: Pull request: ${{ env.PR_TITLE }} <https://github.com/woocommerce/woocommerce/pull/${{ env.PR_NUMBER }}|#${{ env.PR_NUMBER }}>
                  :hash: Trunk merge commit: <https://github.com/woocommerce/woocommerce/commit/${{ env.SHA }}|${{ env.SHA }}>
                  :github: GitHub run log: <https://github.com/woocommerce/woocommerce/actions/runs/${{ github.run_id }}|Run ID ${{ github.run_id }}>
          run: |
              if [ ${{ inputs.test-type }} != "k6" ]; then
                mkdir -p tmp
                echo "$SLACK_MESSAGE" > tmp/slack-message.tmp
                echo ":playwright: Test report: <https://a8c-woo-test-reports.s3.amazonaws.com/public/pr-merge/${{ env.PR_NUMBER }}/${{ steps.lowcase-test-type.outputs.test-type-lowcase }}/index.html|${{ inputs.test-type }} test report on merged PR #${{ env.PR_NUMBER }}>" >> tmp/slack-message.tmp
                echo "slack-message=$(cat tmp/slack-message.tmp)" >> $GITHUB_OUTPUT
              fi

        - name: Send Slack alert on test failure
          uses: slackapi/slack-github-action@v1.23.0
          env:
              SLACK_BOT_TOKEN: ${{ inputs.slack-bot-token }}
          with:
              channel-id: ${{ inputs.channel-id }}
              slack-message: ${{ steps.compose-slack-message.outputs.slack-message }}
