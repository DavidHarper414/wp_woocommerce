#!/usr/bin/env bash
. "$(dirname "$0")/_/husky.sh"

# The hook documentation: https://git-scm.com/docs/githooks.html#_post_checkout
CHECKOUT_TYPE=$3
HEAD_NEW=$2
HEAD_PREVIOUS=$1

whiteColoured='\033[0m'
orangeColoured='\033[1;33m'

# '1' is a branch checkout
if [ "$CHECKOUT_TYPE" = '1' ]; then
	currentPnpmVersion=$( ( command -v pnpm > /dev/null && pnpm -v 2>/dev/null ) || echo 'n/a' )
	if [ "$currentPnpmVersion" = "n/a" ]; then
		echo "pnpm is not installed. Please install pnpm >= 9.7.0:"
		echo "  npm install -g pnpm@latest"
	else
		# Compare current pnpm version to 9.7.0
		if [ "$(printf '%s\n9.7.0\n' "$currentPnpmVersion" | sort -V | head -n 1)" = "$currentPnpmVersion" ] && [ "$currentPnpmVersion" != "9.7.0" ]; then
			echo "Your current pnpm version ($currentPnpmVersion) is older than 9.7.0."
			echo "As of pnpm 9.7.0, pnpm knows how to upgrade or downgrade itself to the correct version."
			echo "Please upgrade to pnpm >= 9.7.0 (e.g., 'npm install -g pnpm@latest')."
		fi
	fi

	# Auto-refresh dependencies when switching between branches.
	changedManifests=$( ( git diff --name-only $HEAD_NEW $HEAD_PREVIOUS | grep -E '(package.json|pnpm-lock.yaml|pnpm-workspace.yaml|composer.json|composer.lock)$' ) || echo '' )
	if [ -n "$changedManifests" ]; then
		printf "${whiteColoured}The following file(s) in the new branch differs from the original one, dependencies might need to be refreshed:\n"
		printf "${whiteColoured}    %s\n" $changedManifests
		printf "${orangeColoured}If you are working on something in this branch, ensure to refresh dependencies with 'pnpm install --frozen-lockfile'\n"
	fi
fi
