const pluginName = 'AsyncChunkSrcVersionParameterPlugin';
/**
 * Inspired by: https://github.com/webpack/webpack/issues/8115#issuecomment-663902035.
 *
 * This plugin modifies the webpack bootstrap code generated by the CSS chunk loading code generated
 * by @automattic/mini-css-extract-plugin-with-rtl.
 *
 * It will append the ?ver parameter to CSS chunk hrefs loaded by @automattic/mini-css-extract-plugin-with-rtl.
 */
class AsyncChunkSrcVersionParameterPlugin {
	_applyMainTemplate( mainTemplate ) {
		// Append script version to all async CSS chunks loaded by @automattic/mini-css-extract-plugin-with-rtl.
		mainTemplate.hooks.requireEnsure.tap(
			// Use stage 1 to ensure this executes after @automattic/mini-css-extract-plugin-with-rtl.
			{ name: pluginName, stage: 1 },
			( source ) => {
				if (
					source.includes( '// mini-css-extract-plugin CSS loading' )
				) {
					return source.replace(
						'linkTag.href = fullhref;',
						`linkTag.href = fullhref;
if ( window.wcAdminAssets && window.wcAdminAssets.version ) {
	linkTag.href += '?ver=' + window.wcAdminAssets.version;
}`
					);
				}

				return source;
			}
		);
	}

	apply( compiler ) {
		compiler.hooks.thisCompilation.tap( pluginName, ( compilation ) => {
			this._applyMainTemplate( compilation.mainTemplate );
		} );
	}
}

module.exports = AsyncChunkSrcVersionParameterPlugin;
