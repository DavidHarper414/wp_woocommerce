<?php
/**
 * WooCommerce Tax Settings
 *
 * @package     WooCommerce\Admin
 * @version     2.1.0
 */

use Automattic\WooCommerce\Utilities\ArrayUtil;

if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

if ( class_exists( 'WC_Settings_Tax', false ) ) {
	return new WC_Settings_Tax();
}

/**
 * WC_Settings_Tax.
 */
class WC_Settings_Tax extends WC_Settings_Page {

	/**
	 * Constructor.
	 */
	public function __construct() {
		$this->id    = 'tax';
		$this->label = __( 'Tax', 'woocommerce' );

		add_filter( 'woocommerce_settings_tabs_array', array( $this, 'add_settings_page' ), 20 );
		add_action( 'woocommerce_admin_field_conflict_error', array( $this, 'conflict_error' ) );
		if ( wc_tax_enabled() ) {
			add_action( 'woocommerce_sections_' . $this->id, array( $this, 'output_sections' ) );
			add_action( 'woocommerce_settings_' . $this->id, array( $this, 'output' ) );
			add_action( 'woocommerce_settings_save_' . $this->id, array( $this, 'save' ) );
		}
	}

	/**
	 * Get tax rates and tax rate classes to be included as extra data in the generated settings export file
	 * when settings are exported.
	 *
	 * @param bool $verbose True if verbose settings export is requested.
	 * @return array|null An associative array containing all the existing tax rates and tax rate classes.
	 */
	public function get_extra_settings_for_export( bool $verbose ): array {
		$tax_rate_class_slugs = WC_Tax::get_tax_class_slugs();
		array_unshift( $tax_rate_class_slugs, '' );
		$tax_rates = array();
		foreach ( $tax_rate_class_slugs as $tax_rate_class_slug ) {
			$rates_for_class = WC_Tax::get_rates_for_tax_class( $tax_rate_class_slug );
			$rates_as_arrays = array();
			foreach ( $rates_for_class as $rate ) {
				$rate_as_array = (array) $rate;
				unset( $rate_as_array['tax_rate_class'] );
				unset( $rate_as_array['city_count'] );
				unset( $rate_as_array['postcode_count'] );
				$rates_as_arrays[] = $rate_as_array;
			}
			$tax_rates[ $tax_rate_class_slug ] = $rates_as_arrays;
		}

		return array(
			'tax_rate_classes' => WC_Tax::get_tax_rate_classes(),
			'tax_rates'        => $tax_rates,
		);
	}

	/**
	 * Applies tax rates and tax rate changes read from an imported settings file.
	 * The mode is ignored, a full import is always performed.
	 *
	 * @param array  $extra_settings The tax rates and and tax rate classes as generated by "apply_extra_exported_settings".
	 * @param bool   $verbose True if the settings where exported with the "verbose" option.
	 * @param string $mode Settings import mode, one of: 'full', 'create_only', 'replace_only' (ignored).
	 * @return int|string On success, the count of tax rates and tax rate classes that have been processed. On failure, an error message.
	 */
	public function apply_extra_exported_settings( array $extra_settings, bool $verbose, string $mode ) {
		global $wpdb;

		$count = 0;

		// Process tax rate classes.

		$known_extra_settings_keys = array( 'tax_rate_classes', 'tax_rates' );
		$extra_settings_key_diff   = ArrayUtil::key_diff( $known_extra_settings_keys, $extra_settings );
		if ( ! empty( $extra_settings_key_diff['missing'] ) ) {
			$missing = implode( ',', $extra_settings_key_diff['missing'] );
			/* translators: %s = list of missing keys */
			return sprintf( __( 'Missing keys in file: %s', 'woocommerce' ), $missing );
		}

		foreach ( $known_extra_settings_keys as $key ) {
			if ( ! is_array( $extra_settings[ $key ] ) ) {
				/* translators: %s = name of key with wrong value */
				return sprintf( __( 'Value of %s is not an array', 'woocommerce' ), $key );
			}
		}

		$existing_tax_rate_classes = WC_Tax::get_tax_rate_classes();
		$count_or_error            = $this->maybe_insert_or_update_imported_item(
			'tax rate class',
			$wpdb->prefix . 'wc_tax_rate_classes',
			'tax_rate_class_id',
			$existing_tax_rate_classes,
			$extra_settings['tax_rate_classes'],
			array( 'tax_rate_class_id', 'name', 'slug' ),
			'full'
		);
		if ( is_string( $count_or_error ) ) {
			return $count_or_error;
		}
		$count += count( $count_or_error );

		// Flatten the list of the tax rates to import and extract tax rate locations from these.

		$flat_tax_rates          = array();
		$flat_tax_rate_locations = array();
		foreach ( $extra_settings['tax_rates'] as $tax_rate_class => $rates ) {
			foreach ( $rates as $rate ) {
				$rate['tax_rate_class'] = $tax_rate_class;
				$flat_tax_rates[]       = $rate;
				$cities                 = array();
				if ( isset( $rate['city'] ) ) {
					foreach ( $rate['city'] as $city ) {
						$cities[] = $city;
					}
					unset( $rate['city'] );
				}
				$postcodes = array();
				if ( isset( $rate['postcode'] ) ) {
					foreach ( $rate['postcode'] as $postcode ) {
						$postcodes[] = $postcode;
					}
					unset( $rate['postcode'] );
				}
				$flat_tax_rate_locations[ $rate['tax_rate_id'] ] = array(
					'cities'    => $cities,
					'postcodes' => $postcodes,
				);
			}
		}

		// Get the existing tax rates and format them to be compatible with the format of the rates to import.

		$existing_tax_rates   = array();
		$tax_rate_class_slugs = ArrayUtil::select( $extra_settings['tax_rate_classes'], 'slug' );
		array_unshift( $tax_rate_class_slugs, '' );
		foreach ( $tax_rate_class_slugs as $tax_rate_class_slug ) {
			$tax_rates_for_class = WC_Tax::get_rates_for_tax_class( $tax_rate_class_slug );
			foreach ( $tax_rates_for_class as $tax_rate ) {
				$tax_rate = (array) $tax_rate;
				unset( $tax_rate['city'] );
				unset( $tax_rate['city_count'] );
				unset( $tax_rate['postcode'] );
				unset( $tax_rate['postcode_count'] );
				$existing_tax_rates[] = $tax_rate;
			}
		}

		// Insert/update tax rates and ajust locations.

		$count_or_error = $this->maybe_insert_or_update_imported_item(
			'tax rate',
			$wpdb->prefix . 'wc_tax_rates',
			'tax_rate_id',
			$existing_tax_rates,
			$flat_tax_rates,
			array( 'tax_rate_id', 'tax_rate_country', 'tax_rate_state', 'tax_rate', 'tax_rate_name', 'tax_rate_priority', 'tax_rate_compound', 'tax_rate_shipping', 'tax_rate_order', 'tax_rate_class' ),
			'full'
		);
		if ( is_string( $count_or_error ) ) {
			return $count_or_error;
		}
		$count += count( $count_or_error );

		foreach ( $flat_tax_rate_locations as $tax_rate_id => $locations ) {
			WC_Tax::_update_tax_rate_cities( $tax_rate_id, $locations['cities'] );
			WC_Tax::_update_tax_rate_postcodes( $tax_rate_id, $locations['postcodes'] );
		}

		return $count;
	}

	/**
	 * Creates the React mount point for the embedded banner.
	 */
	public function conflict_error() {
		?>
		<tr valign="top">
							<th scope="row" class="titledesc woocommerce_admin_tax_settings_slotfill_th">
							</th>
							<td class="forminp forminp-text woocommerce_admin_tax_settings_slotfill_td">
		<div id="wc_conflict_error_slotfill"> </div>
	</td>
	</tr>
		<?php
	}

	/**
	 * Add this page to settings.
	 *
	 * @param array $pages Existing pages.
	 * @return array|mixed
	 */
	public function add_settings_page( $pages ) {
		if ( wc_tax_enabled() ) {
			return parent::add_settings_page( $pages );
		} else {
			return $pages;
		}
	}

	/**
	 * Get own sections.
	 *
	 * @return array
	 */
	protected function get_own_sections() {
		$sections = array(
			''         => __( 'Tax options', 'woocommerce' ),
			'standard' => __( 'Standard rates', 'woocommerce' ),
		);

		// Get tax classes and display as links.
		$tax_classes = WC_Tax::get_tax_classes();

		foreach ( $tax_classes as $class ) {
			/* translators: $s tax rate section name */
			$sections[ sanitize_title( $class ) ] = sprintf( __( '%s rates', 'woocommerce' ), $class );
		}

		return $sections;
	}

	/**
	 * Get settings array.
	 *
	 * @return array
	 */
	public function get_settings_for_default_section() {
		return include __DIR__ . '/views/settings-tax.php';
	}

	/**
	 * Output the settings.
	 */
	public function output() {
		global $current_section;

		$tax_classes = WC_Tax::get_tax_class_slugs();

		if ( 'standard' === $current_section || in_array( $current_section, array_filter( $tax_classes ), true ) ) {
			$this->output_tax_rates();
		} else {
			parent::output();
		}
	}

	/**
	 * Save settings.
	 */
	public function save() {
		// phpcs:disable WordPress.Security.NonceVerification.Missing
		global $current_section;

		if ( ! $current_section ) {
			$this->save_settings_for_current_section();

			if ( isset( $_POST['woocommerce_tax_classes'] ) ) {
				$this->save_tax_classes( wp_unslash( $_POST['woocommerce_tax_classes'] ) ); // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
			}
		} elseif ( ! empty( $_POST['tax_rate_country'] ) ) {
			$this->save_tax_rates();
		} else {
			$this->save_settings_for_current_section();
		}

		$this->do_update_options_action();

		// Invalidate caches.
		WC_Cache_Helper::invalidate_cache_group( 'taxes' );
		WC_Cache_Helper::get_transient_version( 'shipping', true );
		// phpcs:enable WordPress.Security.NonceVerification.Missing
	}

	/**
	 * Saves tax classes defined in the textarea to the tax class table instead of an option.
	 *
	 * @param string $raw_tax_classes Posted value.
	 * @return null
	 */
	public function save_tax_classes( $raw_tax_classes ) {
		$tax_classes          = array_filter( array_map( 'trim', explode( "\n", $raw_tax_classes ) ) );
		$existing_tax_classes = WC_Tax::get_tax_classes();
		$removed              = array_diff( $existing_tax_classes, $tax_classes );
		$added                = array_diff( $tax_classes, $existing_tax_classes );

		foreach ( $removed as $name ) {
			WC_Tax::delete_tax_class_by( 'name', $name );
		}

		foreach ( $added as $name ) {
			$tax_class = WC_Tax::create_tax_class( $name );

			// Display any error that could be triggered while creating tax classes.
			if ( is_wp_error( $tax_class ) ) {
				WC_Admin_Settings::add_error(
					sprintf(
						/* translators: 1: tax class name 2: error message */
						esc_html__( 'Additional tax class "%1$s" couldn\'t be saved. %2$s.', 'woocommerce' ),
						esc_html( $name ),
						$tax_class->get_error_message()
					)
				);
			}
		}

		return null;
	}

	/**
	 * Output tax rate tables.
	 */
	public function output_tax_rates() {
		global $current_section;

		$current_class = $this->get_current_tax_class();

		$countries = array();
		foreach ( WC()->countries->get_allowed_countries() as $value => $label ) {
			$countries[] = array(
				'value' => $value,
				'label' => esc_js( html_entity_decode( $label ) ),
			);
		}

		$states = array();
		foreach ( WC()->countries->get_allowed_country_states() as $label ) {
			foreach ( $label as $code => $state ) {
				$states[] = array(
					'value' => $code,
					'label' => esc_js( html_entity_decode( $state ) ),
				);
			}
		}

		$base_url = admin_url(
			add_query_arg(
				array(
					'page'    => 'wc-settings',
					'tab'     => 'tax',
					'section' => $current_section,
				),
				'admin.php'
			)
		);

		// Localize and enqueue our js.
		wp_localize_script(
			'wc-settings-tax',
			'htmlSettingsTaxLocalizeScript',
			array(
				'current_class' => $current_class,
				'wc_tax_nonce'  => wp_create_nonce( 'wc_tax_nonce-class:' . $current_class ),
				'base_url'      => $base_url,
				'rates'         => array_values( WC_Tax::get_rates_for_tax_class( $current_class ) ),
				'page'          => ! empty( $_GET['p'] ) ? absint( $_GET['p'] ) : 1, // phpcs:ignore WordPress.Security.NonceVerification.Recommended
				'limit'         => 100,
				'countries'     => $countries,
				'states'        => $states,
				'default_rate'  => array(
					'tax_rate_id'       => 0,
					'tax_rate_country'  => '',
					'tax_rate_state'    => '',
					'tax_rate'          => '',
					'tax_rate_name'     => '',
					'tax_rate_priority' => 1,
					'tax_rate_compound' => 0,
					'tax_rate_shipping' => 1,
					'tax_rate_order'    => null,
					'tax_rate_class'    => $current_class,
				),
				'strings'       => array(
					'no_rows_selected'        => __( 'No row(s) selected', 'woocommerce' ),
					'unload_confirmation_msg' => __( 'Your changed data will be lost if you leave this page without saving.', 'woocommerce' ),
					'csv_data_cols'           => array(
						__( 'Country code', 'woocommerce' ),
						__( 'State code', 'woocommerce' ),
						__( 'Postcode / ZIP', 'woocommerce' ),
						__( 'City', 'woocommerce' ),
						__( 'Rate %', 'woocommerce' ),
						__( 'Tax name', 'woocommerce' ),
						__( 'Priority', 'woocommerce' ),
						__( 'Compound', 'woocommerce' ),
						__( 'Shipping', 'woocommerce' ),
						__( 'Tax class', 'woocommerce' ),
					),
				),
			)
		);
		wp_enqueue_script( 'wc-settings-tax' );

		include __DIR__ . '/views/html-settings-tax.php';
	}

	/**
	 * Get tax class being edited.
	 *
	 * @return string
	 */
	private static function get_current_tax_class() {
		global $current_section;

		$tax_classes   = WC_Tax::get_tax_classes();
		$current_class = '';

		foreach ( $tax_classes as $class ) {
			if ( sanitize_title( $class ) === $current_section ) {
				$current_class = $class;
			}
		}

		return $current_class;
	}

	/**
	 * Get a posted tax rate.
	 *
	 * @param string $key   Key of tax rate in the post data array.
	 * @param int    $order Position/order of rate.
	 * @param string $class Tax class for rate.
	 * @return array
	 */
	private function get_posted_tax_rate( $key, $order, $class ) {
		// phpcs:disable WordPress.Security.NonceVerification.Missing -- this is called from 'save_tax_rates' only, where nonce is already verified.
		$tax_rate      = array();
		$tax_rate_keys = array(
			'tax_rate_country',
			'tax_rate_state',
			'tax_rate',
			'tax_rate_name',
			'tax_rate_priority',
		);

		// phpcs:disable WordPress.Security.NonceVerification.Missing
		foreach ( $tax_rate_keys as $tax_rate_key ) {
			if ( isset( $_POST[ $tax_rate_key ], $_POST[ $tax_rate_key ][ $key ] ) ) {
				$tax_rate[ $tax_rate_key ] = wc_clean( wp_unslash( $_POST[ $tax_rate_key ][ $key ] ) );
			}
		}

		$tax_rate['tax_rate_compound'] = isset( $_POST['tax_rate_compound'][ $key ] ) ? 1 : 0;
		$tax_rate['tax_rate_shipping'] = isset( $_POST['tax_rate_shipping'][ $key ] ) ? 1 : 0;
		$tax_rate['tax_rate_order']    = $order;
		$tax_rate['tax_rate_class']    = $class;
		// phpcs:enable WordPress.Security.NonceVerification.Missing

		return $tax_rate;
		// phpcs:enable WordPress.Security.NonceVerification.Missing
	}

	/**
	 * Save tax rates.
	 */
	public function save_tax_rates() {
		// phpcs:disable WordPress.Security.NonceVerification.Missing -- this is called via "do_action('woocommerce_settings_save_'...") in base class, where nonce is verified first.
		global $wpdb;

		$current_class = sanitize_title( $this->get_current_tax_class() );
		// phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotValidated, WordPress.Security.NonceVerification.Missing
		$posted_countries = wc_clean( wp_unslash( $_POST['tax_rate_country'] ) );

		// get the tax rate id of the first submitted row.
		$first_tax_rate_id = key( $posted_countries );

		// get the order position of the first tax rate id.
		$tax_rate_order = absint( $wpdb->get_var( $wpdb->prepare( "SELECT tax_rate_order FROM {$wpdb->prefix}woocommerce_tax_rates WHERE tax_rate_id = %s", $first_tax_rate_id ) ) );

		$index = isset( $tax_rate_order ) ? $tax_rate_order : 0;

		// Loop posted fields.
		// phpcs:disable WordPress.Security.NonceVerification.Missing
		foreach ( $posted_countries as $key => $value ) {
			$mode     = ( 0 === strpos( $key, 'new-' ) ) ? 'insert' : 'update';
			$tax_rate = $this->get_posted_tax_rate( $key, $index ++, $current_class );

			if ( 'insert' === $mode ) {
				$tax_rate_id = WC_Tax::_insert_tax_rate( $tax_rate );
			} elseif ( isset( $_POST['remove_tax_rate'][ $key ] ) && 1 === absint( $_POST['remove_tax_rate'][ $key ] ) ) {
				$tax_rate_id = absint( $key );
				WC_Tax::_delete_tax_rate( $tax_rate_id );
				continue;
			} else {
				$tax_rate_id = absint( $key );
				WC_Tax::_update_tax_rate( $tax_rate_id, $tax_rate );
			}

			if ( isset( $_POST['tax_rate_postcode'][ $key ] ) ) {
				WC_Tax::_update_tax_rate_postcodes( $tax_rate_id, wc_clean( wp_unslash( $_POST['tax_rate_postcode'][ $key ] ) ) );
			}
			if ( isset( $_POST['tax_rate_city'][ $key ] ) ) {
				WC_Tax::_update_tax_rate_cities( $tax_rate_id, wc_clean( wp_unslash( $_POST['tax_rate_city'][ $key ] ) ) );
			}
		}
		// phpcs:enable WordPress.Security.NonceVerification.Missing
	}
}

return new WC_Settings_Tax();
